package de.infolektuell.gradle.jextract.extensions;

import org.gradle.api.Action;
import org.gradle.api.NamedDomainObjectContainer;
import org.gradle.api.file.ConfigurableFileCollection;
import org.gradle.api.file.Directory;
import org.gradle.api.model.ObjectFactory;
import org.gradle.api.provider.SetProperty;
import org.jspecify.annotations.NonNull;

import javax.inject.Inject;
import java.util.regex.Pattern;

/**
 * Configures a source Set to include libraries generated by Jextract
 */
public abstract class SourceSetExtension {
    /**
     * The name of this extension how it is accessible from build.gradle or build.gradle.kts
     */
    public static final String EXTENSION_NAME = "jextract";

    private final String name;
    private final Pattern firstCharPattern = Pattern.compile("^.");
    private final NamedDomainObjectContainer<@NonNull LibraryHandler> libraries;

    @Inject
    public SourceSetExtension(String name) {
        super();
        this.name = name;
        this.libraries = getObjects().domainObjectContainer(LibraryHandler.class);
    }

    /**
     * Contains all header include directories configured as library includes. These are part of the created JMOD archive and are published by the project.
     * @return A collection of directories.
     */
    public abstract ConfigurableFileCollection getIncludePath();

    /**
     * Contains all configured library search paths. These are part of the generated JMOD archive and published by the project.
     * @return A collection of directories.
     */
    public abstract ConfigurableFileCollection getLibraryPath();

    /**
     * Contains all configured directories for legal notices. These are part of the created JMOD archive.
     * @return A set property of directories.
     */
    public abstract SetProperty<@NonNull Directory> getLegalNotices();

    /**
     * Libraries that were defined in the jextract extension. Their generated source and class outputs will be added to the source set.
     */
    public final NamedDomainObjectContainer<@NonNull LibraryHandler> getLibraries() {
        return this.libraries;
    }

    /**
     * Configures the libraries that were defined in the jextract extension. Their generated source and class outputs will be added to the source set.
     */
    public final void libraries(Action<@NonNull NamedDomainObjectContainer<@NonNull LibraryHandler>> action) {
        action.execute(this.libraries);
    }

    /**
     * The name of the scope to declare native dependencies for the current source set.
     * @return The name of a declarable configuration
     */
    public String getNativeImplementationConfigurationName() { return getConfigurationName("nativeImplementation", ""); }

    /**
     * The name of the configuration that resolves native API dependencies
     * @return The name of a resolvable configuration
     */
    public String getIncludePathConfigurationName() { return getConfigurationName("process", "includePath"); }

    /**
     * The name of the configuration that resolves native binary dependencies.
     * @return The name of a resolvable configuration
     */
    public String getArchivePathConfigurationName() { return getConfigurationName("archive", "libraryPath"); }

    @Inject protected abstract ObjectFactory getObjects();

    private String getConfigurationName(String scope, String target) {
        final String capitalizedTarget = firstCharPattern.matcher(target).replaceFirst(m -> m.group().toUpperCase());
        if (this.name.equals("main")) return scope + capitalizedTarget;
        final String capitalizedScope = firstCharPattern.matcher(scope).replaceFirst(m -> m.group().toUpperCase());
        return this.name + capitalizedScope + capitalizedTarget;
    }
}
